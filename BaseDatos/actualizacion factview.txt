USE [Agrocomercio]
GO

/****** Object:  View [dbo].[fac_x_letra]    Script Date: 05/03/2013 16:36:25 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


--/*
ALTER VIEW [dbo].[fac_x_letra] (
icodletra, valor, dfecemision, dfecultpag, dfecnxtvct, dopCod, OpeCod, numfac, 
PrvRazon, opetotpagar, OpeTotal, OpeTotPagPen, PrvCod, moneda, opeestado, estado, 
percod, tra, idet_letra, nsalvenc, tdocod, tipdoc


)
AS --*/

select icodletra, 
valor, dfecemision, dfecultpag, 
dfecnxtvct, dopCod, OpeCod, numfac, PrvRazon, opetotpagar, OpeTotal, OpeTotPagPen, PrvCod, moneda, opeestado, estado, percod, tra, idet_letra,
Convert(numeric(17,2), coalesce ((select nmonto - (select coalesce (sum(nmonto),0) from Pag_letras where idetletra= idet_letra)from det_letra where idetletra= idet_letra ),0)* nporDesc/100 ) as nsalvenc, tdocod , tipdoc from (
select icodletra, opetipo as valor,
cast (dopfecemision as date) as dfecemision, 
cast ((select max(dfecpago) from det_letra where icodletra=do.icodletra)as date) as dfecultpag, 
cast ((select min(dfecvenc) from det_letra where icodletra=do.icodletra and cestado=1)as date) as dfecnxtvct,
dopCod, op.OpeCod , dopNroSerie +'-'+ dopNumero as numfac,
case when OpeTipo ='C' then 
(select PrvRazon from Proveedores where PrvCod =  OP.PrvCod)
else 
(select CliNombre  from Clientes  where CliCod  =  OP.CliCod ) end as PrvRazon, 
opetotpagar , OpeTotal,OpeTotPagPen
, case when OpeTipo ='C' then 
OP.PrvCod else OP.CliCod  end as PrvCod,dopMoneda as moneda,
opeestado, ( select AtrDescripcion from Atributos where AtrTipoCod=6 and AtrCodigo= OpeEstado)as estado
--,case when opeestado ='P' then 'Pendiente' else 'Cancelado' end as estado
,percod, (select perNombres+' '+perApellidoPat from Personal PER where per.perCod= OP.PerCod) as tra
,(select MIN(idetletra) from det_letra where icodletra=do.icodletra and cestado =1) as idet_letra
,OP.nporDesc, DO.tdocod,
 case when OpeTipo = 'C' then
  (select AtrDescripcion from atributos where AtrTipoCod=5 and atrcodigo=DO.tdocod) 
  else   (select AtrDescripcion from atributos where AtrTipoCod=3 and atrcodigo=DO.tdocod)  end as tipdoc
from DocumenOperacion as DO
inner join Operaciones as OP on do.OpeCod= OP.OpeCod

where ((tdoCod in (2, 4) and OpeTipo='C') or 
       (tdoCod in (3, 5) and OpeTipo='V') or
       (tdoCod in (4) and OpeTipo='V' and(select COUNT(*) from DocumenOperacion DCO where DCO.OpeCod = do.OpeCod)=1))  and icodletra is not null and OpeTipPago ='CR'

) as tabla



/*****************************************************************************/


CREATE  VIEW [dbo].vwtodo_movimiento (
tipPag, icodletra
      ,[valor]
      ,[dfecemision]
      ,[dfecultpag]
      ,[dfecnxtvct]
      ,[dopCod]
      ,[OpeCod]
      ,[numfac]
      ,[PrvRazon]
      ,[opetotpagar]
      ,[OpeTotal]
      ,[OpeTotPagPen]
      ,[PrvCod]
      ,[moneda]
      ,[opeestado]
      ,[estado]
      ,[percod]
      ,[tra]
      ,[idet_letra]
      ,[nsalvenc], tdocod, tipdoc

)
AS
select 'Credito' as tipPag, icodletra
      ,[valor]
      ,[dfecemision]
      ,[dfecultpag]
      ,[dfecnxtvct]
      ,[dopCod]
      ,[OpeCod]
      ,[numfac]
      ,[PrvRazon]
      ,[opetotpagar]
      ,[OpeTotal]
      ,[OpeTotPagPen]
      ,[PrvCod]
      ,[moneda]
      ,[opeestado]
      ,[estado]
      ,[percod]
      ,[tra]
      ,[idet_letra]
      ,[nsalvenc], tdocod, tipdoc

  FROM [Agrocomercio].[dbo].[fac_x_letra]
  union  
  select tipPag, icodletra, valor,
   dfecemision, dfecultpag, dfecnxtvct, 
   dopCod, OpeCod, numfac, 
   PrvRazon, opetotpagar, OpeTotal, 
   OpeTotPagPen, PrvCod, moneda, 
   opeestado, estado, percod, 
   tra, idet_letra, nsalvenc, tdocod
   ,case when valor ='C'then(select AtrDescripcion from atributos 
where AtrTipoCod=5 and atrcodigo=tdocod and AtrCodigo!='*') else 
(select AtrDescripcion from atributos 
where AtrTipoCod=3 and atrcodigo=tdocod and AtrCodigo!='*')end as tipdoc
from(
  select 'Contado' as tipPag,OpeCod as icodletra,
  OpeTipo as valor,OpeFecEmision as[dfecemision] ,
  OpeFecCancela as [dfecultpag], null as [dfecnxtvct],
  (select max(dopcod) from DocumenOperacion where OpeCod= Op.opecod)as dopcod, 
  OpeCod,
  (select dopnroserie + '-' +dopNumero from DocumenOperacion where dopcod = (select max(dopcod) from DocumenOperacion where OpeCod= Op.opecod)) as numfac,
  case when OpeTipo ='C' then 
(select PrvRazon from Proveedores where PrvCod =  OP.PrvCod)
else 
(select CliNombre  from Clientes  where CliCod  =  OP.CliCod ) end as PrvRazon, 
opetotpagar , OpeTotal, case when opeestado ='C' then 0.00 else OpeTotPagPen end as OpeTotPagPen 
, case when OpeTipo ='C' then 
OP.PrvCod else OP.CliCod  end as PrvCod,opeMoneda as moneda,
opeestado, 
( select AtrDescripcion from Atributos where AtrTipoCod=6 and AtrCodigo= OpeEstado)as estado,
PerCod,
(select perNombres+' '+perApellidoPat from Personal PER where per.perCod= OP.PerCod) as tra
, 0 as idet_letra , 0.00 as nsalvenc, (select tdocod from DocumenOperacion where dopcod =((select max(dopcod) from DocumenOperacion where OpeCod= Op.opecod))) as tdocod from Operaciones as op
  where OpeTipPago='CO') as tabla
  


