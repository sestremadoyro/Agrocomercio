

ALTER VIEW [dbo].[list_detLetra] (
valor, dfecven, cuota, ccodletra, cnumletra, PrvRazon, estado, dfecpag, cmoneda, mnt_cuota, mnt_letra, Saldo_total, ninteres, PrvCod, cestado, icodletra, idetletra

)
AS

SELECT distinct OP.OpeTipo as valor
,[dfecvenc]as dfecven
,convert(varchar, inumletra) + ' de '+convert(varchar,(select MAX(inumletra) from [det_letra] SDE where SDE.icodletra = DE.icodletra)) as cuota
,[ccodletra]
,[cnumletra]
, PR.PrvRazon 
,case when [cestado]='1' then 'X Pagar' else 'Pagada' end as estado
,coalesce( CONVERT (nvarchar(30),[dfecpago], 111 )  ,'--')as dfecpag
,cmoneda 
,nmonto as mnt_cuota
,LE.nmontocuota as mnt_letra
,(select coalesce (sum(nmonto),0.00)  from det_letra SDE where SDE.icodletra= DE.icodletra  and cestado ='1') as Saldo_total
,[ninteres]
,OP.PrvCod 
,[cestado]
, DE.[icodletra]
,[idetletra]  
 
 FROM [Agrocomercio].[dbo].[det_letra] DE
 inner join DocumenOperacion DO on DE.icodletra = DO.icodletra 
 inner join Operaciones OP on OP.OpeCod = DO.OpeCod 
 inner join Proveedores PR on PR.PrvCod = OP.PrvCod 
 inner join letra LE on LE.icodigo = DE.icodletra

GO

--select * from Operaciones
ALTER VIEW [dbo].[fac_x_letra] (
icodletra, valor,dfecemision,dfecultpag, dopCod, OpeCod ,numfac, PrvRazon, opetotpagar, OpeTotal,OpeTotPagPen,
 PrvCod, monedas, opeestado,estado, percod, tranom

)
AS
select icodletra, opetipo as valor,
cast (dopfecemision as date) as dfecemision, 
cast ((select max(dfecpago) from det_letra where icodletra=do.icodletra)as date) as dfecultpag, 
dopCod, op.OpeCod , dopNroSerie +'-'+ dopNumero as numfac,
case when OpeTipo ='C' then 
(select PrvRazon from Proveedores where PrvCod =  OP.PrvCod)
else 
(select CliNombre  from Clientes  where CliCod  =  OP.CliCod ) end as PrvRazon, 
opetotpagar , OpeTotal,OpeTotPagPen
, case when OpeTipo ='C' then 
OP.PrvCod else OP.CliCod  end as PrvCod,dopMoneda,
opeestado, case when opeestado ='P' then 'Pendiente' else 'Cancelado' end as estado
,percod, (select perNombres+' '+perApellidoPat from Personal PER where per.perCod= OP.PerCod) as tra
from DocumenOperacion as DO
inner join Operaciones as OP on do.OpeCod= OP.OpeCod

where ((tdoCod in (2, 4) and OpeTipo='C') or (tdoCod in (3, 5) and OpeTipo='V'))  and icodletra is not null and OpeTipPago ='CR'



GO
. x 	Kg
